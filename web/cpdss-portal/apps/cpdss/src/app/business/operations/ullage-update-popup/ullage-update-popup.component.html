<p-dialog id="dialog_newLoadableStudyPopup" header="{{'UPDATE ULLAGE' | translate}}" [visible]="true" *ngIf="display"
    [modal]="true" styleClass="new-loadable-study-pop-up" [draggable]="false" [responsive]="true" [minY]="70"
    [closable]="false">

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-4">
                <i class="pi pi-upload"></i>
            </div>
            <div class="col-md-4">
                <label for="">{{'LOADABLE_PLAN_ULLAGE_UPDATE_STATUS_LABEL' | translate}}</label> <span class="pl-20">
                    <label>{{ status === ULLAGE_STATUS.ARRIVAL ? ('ULLAGE_UPDATE_STATUS_LABEL_ARRIVAL' | translate) : ('ULLAGE_UPDATE_STATUS_LABEL_DEPARTURE' | translate)}}</label>
                </span>
            </div>
            
        </div>
        <div class="row">
            <div class="col-md-12 text-center">
                <div class="pt-15">
                    <div class="col  text-center">
                        <a class="tab-btn tab-btn-default tab-landing tank-icon" [ngClass]="{'active': selectedTab === tankType.CARGO}" pTooltip="{{'CARGO' | translate}}" tooltipPosition="top"
                            id="ship_landing_cargo_tab" (click)="onTabClick(tankType.CARGO)">
                        </a>
                        <a class="tab-btn tab-btn-default tab-landing ballast-icon" [ngClass]="{'active': selectedTab === tankType.BALLAST}" pTooltip="{{'BALLAST' | translate}}" tooltipPosition="top"
                            id="ship_landing_ballast_tab" (click)="onTabClick(tankType.BALLAST)">
                        </a>
                        <a class="tab-btn tab-btn-default tab-landing bunker-icon" [ngClass]="{'active': selectedTab === tankType.BUNKER}" pTooltip="{{'BUNKER' | translate}}" tooltipPosition="top"
                        id="ship_landing_bunker_tab" (click)="onTabClick(tankType.BUNKER)">
                    </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="row pt-20">
            <div class="col-md-4">
                <cpdss-portal-datatable *ngIf="selectedTab === tankType.CARGO" [value]="cargoQuantities" [filterable]="false"
                    [tableId]="'user_list'" [selectionMode]="selectionMode" (columnClick)="onRowSelection($event)" [(selection)]="selectedTank" (editComplete)="cargoEditCompleted($event)" [form]="cargoTankForm"  [editMode]="editMode" [columns]="cargoColumns"></cpdss-portal-datatable>
                    <cpdss-portal-datatable [selectionMode]="selectionMode" [form]="ballastTankForm" [editMode]="editMode" *ngIf="selectedTab === tankType.BALLAST" (editComplete)="ballastEditCompleted($event)" [value]="ballastQuantities" [filterable]="false"
                    [tableId]="'user_list'" (columnClick)="onRowSelection($event)" [(selection)]="selectedTank" [columns]="ballastColumns"></cpdss-portal-datatable>
                    <cpdss-portal-datatable [selectionMode]="selectionMode" *ngIf="selectedTab === tankType.BUNKER" [value]="bunkerTanksList" [filterable]="false"
                    [tableId]="'user_list'" (columnClick)="onRowSelection($event)" [(selection)]="selectedTank" [form]="bunkerTankForm" [editMode]="editMode" [columns]="bunkerColumns"></cpdss-portal-datatable>
            </div>
            <div class="col-md-8">
                
                <div>
                    <div class="row">
                        
                        <div class="col landing-page-tank-wrapper m-auto" *ngIf="selectedTab === tankType.CARGO">
                            <div class="col">
                                <div class="col">
                                    <label for="">{{'LOADABLE_PLAN_ULLAGE_UPDATE_SHOW_AS_LABEL'| translate}}</label> <span class="pl-20">
                                        <p-dropdown [(ngModel)]="showAs"  filter="true"  (onChange)="showAsChange($event)" [options]="showAsOptions" optionLabel="label"
                                            resetFilterOnHide="true"></p-dropdown>
                                    </span>
                                </div>
                            </div>
                            <div class="col">
                                <span>{{'LOADABLE_PLANE_CARGO_GRADE' | translate}}</span>
                                <p-dropdown styleClass="form-control" [(ngModel)]="selectedCargo" [options]="ullageResponseData?.billOfLaddingList" appendTo="body" 
                                id="cargo_name"  optionLabel="cargoAbbrevation"
                                focusTrap resetFilterOnHide="true" [filter]="true" (onChange)="changeCargo($event)"></p-dropdown>
    
                                <span>{{'LOADABLE_PLANE_CARGO_GRADE' | translate}}</span>
                                <ul class="list-inline text-center tank-order mb-5">
                                    <li class="list-inline-item" *ngFor="let cargoDetail of ullageResponseData?.billOfLaddingList">
                                        <span class="badge-custom mr-5" class="badge-custom" [ngClass]="cargoDetail?.isCommingle ? 'commingle' : ''"
                                        [ngStyle]="!cargoDetail?.isCommingle && {'background': cargoDetail.cargoColor}">
                                            {{cargoDetail.cargoAbbrevation}} </span> <span class="ml-5 mr-5">></span>
                                    </li>
                                </ul>
                            </div>
                            
                            <div class="col">
                                <ng-container *ngIf="percentageFilled">
                                    <span>{{percentageFilled }}</span><span>{{'LOADABLE_PLAN_FILLED' | translate}}</span>
                                </ng-container>
                                <cpdss-portal-cargo-tank-layout [(selectedTankId)]="selectedTankId" [tanks]="cargoTanks" [options]="cargoTankOptions">
                                </cpdss-portal-cargo-tank-layout>
                            </div>
                            
                        </div>
                        <div class="col-11 m-auto loadable-plan-ballast landing-page-tank-wrapper" *ngIf="selectedTab === tankType.BALLAST">
                            <cpdss-portal-ballast-layout [(selectedTankId)]="selectedTankId" [tanks]="centerBallastTanks" [rearTanks]="rearBallastTanks"
                                    [frontTanks]="frontBallastTanks" [options]="ballastTankOptions">
                                </cpdss-portal-ballast-layout>
                                
                        </div>
                        <div class="col col-7 m-auto landing-page-tank-wrapper" *ngIf="selectedTab === tankType.BUNKER">
                            <div class="col text-center pb-10 pt-10">
                                <span class="mr-10 text-uppercase text-secondary">{{'SHIP_LANDING_TYPE'| translate}}</span>
                                <ng-container *ngFor="let fuelType of fuelTypes">
                                    <span class="badge-custom mr-5" *ngIf="fuelType?.shortName"
                                        [ngStyle]="{'background-color': fuelType?.colorCode}">{{fuelType?.shortName}}</span>
                                </ng-container>
                
                            </div>
                            <ng-container *ngIf="percentageFilled">
                                <span>{{percentageFilled }}</span><span>{{'LOADABLE_PLAN_FILLED' | translate}}</span>
                            </ng-container>
                            <cpdss-portal-bunkering-layout [(selectedTankId)]="selectedTankId" [tanks]="bunkerTanks" [rearTanks]="rearBunkerTanks" [options]="ohqTankOptions">
                            </cpdss-portal-bunkering-layout>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div *ngIf="selectedTab === tankType.CARGO" class="row">
            <div class="col-md-4">
                <label>{{'LOADABLE_PLAN_BL_FIGURE_HEADING'| translate}}</label>
            </div>
        </div>
        <div *ngIf="selectedTab === tankType.CARGO" class="row">
            <form>
                <ng-container>
                    <p-table [value]="blFigure.items" [columns]="blFigureColumns" dataKey="cargoName">
                        <ng-template pTemplate="header" let-columns>
                            <tr>
                                <th *ngFor="let col of columns">{{col?.header | translate}}</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-rowData let-rowIndex="rowIndex" let-columns="columns">
                            <ng-container>
                                <ng-container *ngFor="let column of rowData;let index=index">
                                    <ng-container>
                                        <ng-container 
                                            *ngTemplateOutlet="rowTemplate;context:{rowData: column.cargo, rowIndex: rowIndex, columns: columns , index:index}">
                                        </ng-container>
                                    </ng-container>
                                </ng-container>  
                        </ng-container>
                            <ng-template #rowTemplate let-rowData="rowData"  
                            let-rowIndex="rowIndex" let-columns="columns" let-index="index" >
                            <ng-container>
                            <tr>
                                <ng-container *ngFor="let col of columns; let subIndex = index">
                                    <ng-container
                                    *ngTemplateOutlet="cell;context:{rowData: rowData, column: col, colIndex: subIndex, rowIndex: rowIndex, columns: columns , index:index}">
                                    </ng-container>
                                </ng-container>
                            </tr>
                            </ng-container>
                            </ng-template>  
                            
                            <ng-template #cell let-rowData="rowData" let-col="column" let-colIndex="colIndex"
                            let-rowIndex="rowIndex" let-columns="columns" let-index="index">

                                <td (click)="onClick($event, rowData, rowIndex, col)"  [pEditableColumn]="rowData"
                                [pEditableColumnField]="col.field" [pEditableColumnRowIndex]="rowIndex" *ngIf="isCellVisable(index, col)" [ngSwitch]="col.fieldType"  [attr.rowspan]="calculateRowSpan(index, colIndex , rowIndex)">
                                
                                   <ng-container *ngSwitchCase="fieldType.NUMBER">
                                    <ng-container *ngIf="editMode && rowData[col.field]?.isEditMode">
                                        <input type="text" cpdssPortalNumberDecimal [min]="0" class="form-control"
                                        id="{{rowIndex+col.field+index}}" [formControl]="getControl(rowIndex,index,col.field)" 
                                        (blur)="onEditComplete($event,rowData,col.field,rowIndex,index)"
                                        >
                                    </ng-container>
                                    <ng-container *ngIf="!editMode || !rowData[col.field]?.isEditMode">
                                        <span>{{rowData[col.field].value| number:col?.numberFormat}}</span>
                                    </ng-container>
                                        <cpdss-portal-validation-error [errors]="fieldError(rowIndex,index,col.field)"
                                            [errorMessages]="col?.errorMessages">
                                        </cpdss-portal-validation-error>
                                    </ng-container>

                                <ng-container *ngSwitchCase="fieldType.TEXT">
                                    <ng-container  *ngIf="editMode && rowData[col.field]?.isEditMode">
                                        <input type="text" class="form-control" 
                                        id="{{rowIndex+col.field+index}}"  [formControl]="getControl(rowIndex,index,col.field)"
                                        (blur)="onEditComplete($event,rowData, col.field, rowIndex,index)">
                                    </ng-container>
                                    <ng-container *ngIf="!editMode || !rowData[col.field]?.isEditMode">
                                        <span>{{rowData[col.field].value}}</span>
                                    </ng-container>
                                    <cpdss-portal-validation-error [errors]="fieldError(rowIndex,index,col.field)"
                                    [errorMessages]="col?.errorMessages">
                                </cpdss-portal-validation-error>
                                </ng-container>

                                <ng-container *ngSwitchCase="fieldType.ACTION">
                                    <i class="pi pi-minus-circle" *ngIf="index !== 0" (click)="deleteCargo(rowIndex,index)"></i>
                                    <i class="pi pi-plus-circle" *ngIf="index === 0" (click)="newCargo(rowIndex,index)"></i>
                                </ng-container>
                                

                                <ng-container *ngSwitchDefault>
                                    {{rowData[col.field]}}
                                </ng-container>

                                </td>

                            </ng-template>  

                        </ng-template>
                        <ng-template pTemplate="footer" let-columns>
                            <tr>
                                <td colspan="2">{{'LOADABLE_QUANTITY_TOTAL' | translate}}</td>
                                <td>{{blFigureTotal?.bbl | quantityDecimalFormat: 'OBSBBLS'}}</td>
                                <td>{{blFigureTotal?.lt | quantityDecimalFormat: 'LT' }}</td>
                                <td>{{blFigureTotal?.mt |quantityDecimalFormat: 'MT'}}</td>
                                <td>{{blFigureTotal?.kl | quantityDecimalFormat: 'KL'}}</td>
                                <td>{{blFigureTotal?.api | number: '0.2-2'}}</td>
                                <td></td>
                                <td></td>
                            </tr>
                        </ng-template>
                    </p-table>
                </ng-container>
            </form>
        </div>
        <div *ngIf="selectedTab === tankType.CARGO" class="row">
            <div class="col-md-4 pt-20">
                {{'LOADABLE_PLAN_CARGO_QUANTITY_TABLE' | translate}}
            </div>
        </div>
        <div *ngIf="selectedTab === tankType.CARGO" class="row">
            <div class="col-md-12 pt-20">
                <p-table [value]="cargoQuantityList">
                    <ng-template pTemplate="header">
                        <tr>
                            <th rowspan="2">{{'LOADABLE_PLAN_CARGO_GRADE_NAME' | translate}}</th>
                            <th rowspan="2">{{'LOADABLE_PLAN_CARGO_GRADE_NOMINATION_FIG_IN_BBLS' | translate}}</th>
                            <th rowspan="2"></th>
                            <th rowspan="2">{{'LOADABLE_PLAN_CARGO_GRADE_BBLS@60F'| translate}}</th>
                            <th rowspan="2">{{'LOADABLE_PLAN_CARGO_GRADE_LT'| translate}}</th>
                            <th rowspan="2">{{'LOADABLE_PLAN_CARGO_GRADE_MT'| translate}}</th>
                            <th rowspan="2">{{'LOADABLE_PLAN_CARGO_GRADE_KL@15C'| translate}}</th>
                            <th rowspan="2">{{'LOADABLE_PLAN_CARGO_GRADE_API'| translate}}</th>
                            <th rowspan="2">{{'LOADABLE_PLAN_CARGO_GRADE_TEMP'| translate}}</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-row let-index>
                            <tr>
                                <td rowspan="4">{{row.cargoAbbrevation}}</td>
                                <td rowspan="4">{{row.nominationTotal}}</td>
                                <td>{{'ULLAGE_UPDATE_PLAN_LABEL' | translate}}</td>
                                <td>{{row.plan.bbl}}</td>
                                <td>{{row.plan.lt}}</td>
                                <td>{{row.plan.mt}}</td>
                                <td>{{row.plan.kl}}</td>
                                <td>{{row.plan.api}}</td>
                                <td>{{row.plan.temp}}</td>
                            </tr>
                            <tr>
                                <td>{{'ULLAGE_UPDATE_ACTUAL_LABEL' | translate}}</td>
                                <td>{{row.actual.bbl}}</td>
                                <td>{{row.actual.lt}}</td>
                                <td>{{row.actual.mt}}</td>
                                <td>{{row.actual.kl}}</td>
                                <td>{{row.actual.api}}</td>
                                <td>{{row.actual.temp}}</td>
                            </tr>
                            <tr>
                                <td>{{'ULLAGE_UPDATE_BLFIG_LABEL' | translate}}</td>
                                <td>{{row.blFigure.bbl}}</td>
                                <td>{{row.blFigure.lt}}</td>
                                <td>{{row.blFigure.mt}}</td>
                                <td>{{row.blFigure.kl}}</td>
                                <td>{{row.blFigure.api}}</td>
                                <td>{{row.blFigure.temp}}</td>
                            </tr>
                            <tr>
                                <td>{{'ULLAGE_UPDATE_DIFF_LABEL' | translate}}</td>
                                <td>{{row.difference.bbl}}</td>
                                <td>{{row.difference.lt}}</td>
                                <td>{{row.difference.mt}}</td>
                                <td>{{row.difference.kl}}</td>
                                <td>{{row.difference.api}}</td>
                                <td>{{row.difference.temp}}</td>
                            </tr>
                            <tr>
                                <td colspan="2"></td>
                                <td>{{'ULLAGE_UPDATE_DIFFPER_LABEL' | translate}}</td>
                                <td>{{row.diffPercentage.bbl}}</td>
                                <td>{{row.diffPercentage.lt}}</td>
                                <td>{{row.diffPercentage.mt}}</td>
                                <td>{{row.diffPercentage.kl}}</td>
                                <td>{{row.diffPercentage.api}}</td>
                                <td>{{row.diffPercentage.temp}}</td>
                            </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>
    </div>

    <p-footer>
        <div class="row">
            <div class="col-sm-12 text-right">
                <button type="button" class="btn btn-main" (click)="closeDialog()" id="new-loadable-study-popup-cancel"
                    focusTrap>{{'NEW_LOADABLE_STUDY_POPUP_CANCEL_BUTTON' | translate}}</button>
                <button (click)="saveUllage(false)" class="btn btn-main" id="new-loadable-study-popup-save" form="fg_newLoadableStudy"
                    autofocus focusTrap>{{'SAVE' | translate}}</button>
                    <button (click)="saveUllage(true)" class="btn btn-main" id="new-loadable-study-popup-save" form="fg_newLoadableStudy"
                    autofocus focusTrap>{{'ULLAGE_UPDATE_SAVE_AND_VALIDATE_LABEL' | translate}}</button>
            </div>
        </div>
    </p-footer>
</p-dialog>