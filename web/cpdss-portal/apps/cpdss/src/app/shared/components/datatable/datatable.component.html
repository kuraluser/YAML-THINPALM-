<div *ngIf="form" [formGroup]="form" class="row" style="height: 100%">
    <div formArrayName="dataTable" class="col" style="height: 100%">
        <p-table #datatable  [columns]="columns"   [scrollable]="true" scrollHeight="flex" [value]="value" [editMode]="editMode" [selectionMode]="selectionMode" [loading]="loading"
            (onEditComplete)="onEditComplete($event)" (onRowSelect)="onRowSelect($event)" [(selection)]="selection"
            (columnClick)="onClick($event)" [reorderableColumns]="tableRowReOrder" (onRowReorder)="onRowReorder($event)"
            (onFilter)="onFilter($event)" [customSort]="customSort" (sortFunction)="sortFunction($event)"
            [lazy]="lazy" (onLazyLoad)="loadDetails($event)"> 
            <ng-template pTemplate="colgroup" let-columns>
                <colgroup>
                    <col *ngIf="progress" class="column-class column-loader">
                    <col *ngIf="tableRowReOrder" class="column-class re-order">
                    <ng-container *ngFor="let col of columns">
                        <col *ngIf="!col?.columns?.length" class="column-class" [class]="col.fieldHeaderClass"
                            [ngClass]="{'column-actions': col?.field === 'actions'}">
                        <col *ngFor="let subCol of col?.columns" class="column-class" [class]="subCol.fieldHeaderClass">
                    </ng-container>
                </colgroup>
            </ng-template>
            <ng-template pTemplate="header" let-columns>
                <tr>
                    <th *ngIf="progress"></th>
                    <th *ngIf="tableRowReOrder"></th>
                    <th *ngFor="let col of columns" [pSortableColumn]="col?.sortField ? col?.sortField : col.field"
                        [pSortableColumnDisabled]="!col.sortable" [colSpan]="col?.columns?.length"
                        [rowSpan]="col?.columns?.length ? 1 : getRowSpan(columns, filterable)" [class]="col?.fieldColumnClass">
                        <span>{{col.header| translate}}</span>
                        <p-sortIcon [field]="col?.sortField ? col?.sortField : col.field" *ngIf="col.sortable">
                        </p-sortIcon>
                    </th>
                </tr>
                <tr>
                    <th *ngIf="progress"></th>
                    <th *ngIf="tableRowReOrder"></th>
                    <ng-container *ngFor="let col of columns; let colIndex = index">
                        <ng-container *ngIf="col?.columns?.length;">
                            <th *ngFor="let subCol of col?.columns" [class]="subCol?.fieldColumnClass">
                                <span>{{subCol.header| translate}}</span>
                                <p-sortIcon [field]="subCol?.sortField ? subCol?.sortField : subCol.field"
                                    *ngIf="subCol.sortable"></p-sortIcon>
                            </th>
                        </ng-container>
                    </ng-container>
                </tr>
                <ng-container *ngIf="filterable">
                    <tr>
                        <th *ngIf="progress"></th>
                        <th *ngIf="tableRowReOrder"></th>
                        <th *ngFor="let col of columns" [colSpan]="col?.columns?.length"
                            [rowSpan]="col?.columns?.length ? 1 : getRowSpan(columns, filterable)">
                            <ng-container *ngTemplateOutlet="filterTemplate;context:{column:col}">
                            </ng-container>
                        </th>
                    </tr>
                    <tr>
                        <th *ngIf="progress"></th>
                        <th *ngIf="tableRowReOrder"></th>
                        <ng-container *ngFor="let col of columns">
                            <ng-container *ngIf="col?.columns?.length;">
                                <ng-container *ngFor="let subCol of col?.columns">
                                    <th>
                                        <ng-container *ngTemplateOutlet="filterTemplate;context:{column:subCol}">
                                        </ng-container>
                                    </th>
                                </ng-container>
                            </ng-container>
                        </ng-container>
                    </tr>
                </ng-container>
                <ng-template #filterTemplate let-col="column">
                    <ng-container *ngIf="col.filter" [ngSwitch]="col.filterType">
                        <input *ngSwitchCase="filterType.TEXT" type="text" id="{{col.field+'_filter'}}"
                            (input)="filterData($event , col)" [ngModel]="filterObject[col.filterField]" [ngModelOptions]="{standalone: true}"
                            [placeholder]="col.filterPlaceholder| translate" class="p-column-filter">
                        <input *ngSwitchCase="filterType.NUMBER" type="number" id="{{col.field+'_filter'}}"
                            (input)="datatable.filter($event.target.value, col?.filterField ? col?.filterField : col.field, col.filterMatchMode)"
                            [placeholder]="col.filterPlaceholder| translate" class="p-column-filter">
                        <input *ngSwitchCase="filterType.ARRAY" type="text" id="{{col.field+'_filter'}}"
                            (input)="datatable.filter($event.target.value.trim(), col.arrayFilterField, col.filterMatchMode)"
                            [placeholder]="col.filterPlaceholder| translate" class="p-column-filter">
                            <p-calendar appendTo="body" *ngSwitchCase="filterType.DATE"
                            [maxDate]="col.filterFieldMaxvalue"
                            (onSelect)="onDateSelect($event, col?.filterField, col?.filterMatchMode)" keepInvalid="true"
                            (onInput)="onDateFilter($event.target.value, col?.filterField, col?.filterMatchMode)"
                            (onClearClick)="datatable.filter('', col?.filterField, 'contains')"
                            [showButtonBar]="true" styleClass="p-column-filter"
                            [placeholder]="col.filterPlaceholder| translate" [readonlyInput]="false"
                            dateFormat="dd-mm-yy" id="{{col.field+'_filter'}}">
                        </p-calendar>
                        <p-dropdown *ngSwitchCase="filterType.SELECT" [options]="listData[col.filterListName]"
                            [showClear]="true" appendTo="body" optionLabel="name"
                            [placeholder]="col.filterPlaceholder| translate"
                            (onChange)="datatable.filter($event.value?.id, col?.filterField ? col?.filterField : col.field, col.filterMatchMode)">
                        </p-dropdown>
                    </ng-container>
                </ng-template>
            </ng-template>
            <ng-template pTemplate="body" let-rowData let-rowIndex="rowIndex" let-columns="columns">
                <tr formGroupName="{{rowIndex}}" [pSelectableRow]="rowData" [pSelectableRowIndex]="rowIndex"
                    [pSelectableRowDisabled]="!selectionMode" [pReorderableRow]="row(rowIndex)?.valid && rowIndex">
                    <td *ngIf="progress">
                        <i class="pi" [ngClass]="{'pi-spin pi-spinner row-loader': rowData['processing']}"></i>
                    </td>
                    <td *ngIf="tableRowReOrder">
                        <span class="pi pi-bars" pReorderableRowHandle></span>
                    </td>
                    <ng-container *ngFor="let col of columns; let colIndex = index">
                        <ng-container *ngIf="!col?.columns?.length">
                            <ng-container
                                *ngTemplateOutlet="rowTemplate;context:{rowData: rowData, column: col, colIndex: colIndex, rowIndex: rowIndex, columns: columns}">
                            </ng-container>
                        </ng-container>

                        <ng-container *ngFor="let subCol of col?.columns; let subColIndex = index">
                            <ng-container
                                *ngTemplateOutlet="rowTemplate;context:{rowData: rowData, column: subCol, colIndex: subColIndex, rowIndex: rowIndex, columns: columns}">
                            </ng-container>
                        </ng-container>
                    </ng-container>
                    <ng-template #rowTemplate let-rowData="rowData" let-col="column" let-colIndex="colIndex"
                        let-rowIndex="rowIndex" let-columns="columns">
                        <td [class]="col.fieldClass" [ngSwitch]="col.fieldType"
                            [pEditableColumn]="rowData" [pEditableColumnField]="col.field"
                            [pEditableColumnRowIndex]="rowIndex" (click)="onClick($event, rowData, rowIndex, col)">
                            <div [attr.tabindex]="col.field !== 'actions' && col.fieldType !== fieldType.SLNO ? (rowIndex*10)+colIndex+rowIndex : null"
                                (keyup)="onFocus($event, rowData, col, colIndex)" id="{{'cell'+col.field + '_' + rowIndex}}">
                                
                                <ng-container *ngIf="!lazy;else lazyRef">
                                    <span *ngSwitchCase="fieldType.SLNO">{{rowData[col.field] ? rowData[col.field] :
                                        rowIndex+ 1}}</span>
                                    <span *ngSwitchCase="fieldType.ICON"><i
                                            class="{{col.fieldValueIcon+'-'+rowData[col.field]}}"></i></span>
                                </ng-container>
                                <ng-template #lazyRef>
                                    <span *ngSwitchCase="fieldType.SLNO">{{getSlNo(rowIndex)}}</span>
                                </ng-template>

                                <ng-container *ngSwitchCase="fieldType.ACTION">
                                    <div class="action-buttons" *ngIf="rowData.isActionsEnabled === undefined || rowData.isActionsEnabled">
                                        <p-splitButton appendTo="body" id="{{tableId + 'split_button_' + rowIndex}}"
                                            *ngIf="col.actions.length > 1" icon="null"
                                            menuStyleClass="grid-dropdown-menu" styleClass="grid-dropdown-icon"
                                            [model]="getMoreOptions(rowData)"
                                            (onDropdownClick)="onDropdownClick($event, rowData, rowIndex, col)">
                                        </p-splitButton>
                                        <a type="button" id="{{tableId + 'option_button' + rowIndex}}"
                                            class="{{moreOptions[0].icon}}" *ngIf="col.actions.length === 1"
                                            (click)="onOptionClick($event, rowData, rowIndex, col, moreOptions[0])"></a>
                                    </div>
                                </ng-container>

                                <ng-container *ngSwitchCase="fieldType.TEXT">
                                    <ng-container *ngIf="editMode && rowData[col.field]?.isEditMode">
                                        <input type="text" class="form-control" [formControlName]="col.field"
                                            [placeholder]="col.fieldPlaceholder| translate"
                                            (change)="onChange($event, rowData, rowIndex, col)"
                                            id="{{col.field+'_'+rowIndex}}"
                                            [readonly]="!rowData[col.field]?.isEditable">
                                        <cpdss-portal-validation-error [errors]="fieldError(rowIndex, col.field)"
                                            [errorMessages]="col.errorMessages">
                                        </cpdss-portal-validation-error>
                                    </ng-container>
                                    <ng-container *ngIf="!editMode || !rowData[col.field]?.isEditMode">
                                        <span>{{rowData[col.field].value}}</span>
                                    </ng-container>
                                </ng-container>

                                <ng-container *ngSwitchCase="fieldType.NUMBER">
                                    <ng-container *ngIf="editMode && rowData[col.field]?.isEditMode">
                                        <input type="text" cpdssPortalNumberDecimal class="form-control"
                                            [formControlName]="col.field"
                                            [placeholder]="col.fieldPlaceholder| translate"
                                            (change)="onChange($event, rowData, rowIndex, col)"
                                            id="{{col.field+'_'+rowIndex}}">
                                        <i *ngIf="rowData[col.field]?.value && col.fieldValueIcon"
                                            class="{{col.fieldValueIcon}}"
                                            (click)="onCellValueClick($event, rowData, rowIndex, col)"></i>
                                        <cpdss-portal-validation-error [errors]="fieldError(rowIndex, col.field)"
                                            [errorMessages]="col.errorMessages">
                                        </cpdss-portal-validation-error>
                                    </ng-container>
                                    <ng-container *ngIf="!editMode || !rowData[col.field]?.isEditMode">
                                        <span>{{rowData[col.field]?.value | number:
                                            col?.numberFormat}}{{rowData[col.field]?.value? col.fieldSuffix
                                            : ''}}
                                            <i *ngIf="rowData[col.field]?.value && col.fieldValueIcon"
                                                class="{{col.fieldValueIcon}}"
                                                (click)="onCellValueClick($event, rowData, rowIndex, col)"></i></span>
                                    </ng-container>
                                </ng-container>

                                <ng-container *ngSwitchCase="fieldType.SELECT">
                                    <ng-container *ngIf="editMode && rowData[col.field]?.isEditMode">
                                        <p-dropdown [options]="listData[col.listName]" styleClass="form-control"
                                            appendTo="body" [formControlName]="col.field" [filter]="col.listFilter"
                                            optionLabel="{{col.fieldOptionLabel}}"
                                            [placeholder]="col.fieldPlaceholder| translate"
                                            (onChange)="onChange($event, rowData, rowIndex, col)"
                                            id="{{col.field+'_'+rowIndex}}" [virtualScroll]="col.virtualScroll"
                                            itemSize="30">
                                        </p-dropdown>
                                        <cpdss-portal-validation-error [errors]="fieldError(rowIndex, col.field)"
                                            [errorMessages]="col.errorMessages">
                                        </cpdss-portal-validation-error>
                                    </ng-container>
                                    <ng-container *ngIf="!editMode || !rowData[col.field]?.isEditMode">
                                        <span *ngIf="rowData[col.field]?.value?.name">{{ rowData[col.field]?.value?.name
                                            }}</span>
                                        <span *ngIf="rowData[col.field]?.value?.operationName">{{
                                            rowData[col.field]?.value?.operationName }}</span>
                                        <span
                                            *ngIf="!rowData[col.field]?.value?.name && !rowData[col.field]?.value?.operationName">{{
                                            rowData[col.field]?.value }}</span>
                                    </ng-container>
                                </ng-container>


                                <ng-container *ngSwitchCase="fieldType.COLOR" class="col no-left-padding"
                                    style="max-width: 20px;">
                                    <div class="color-rounded mt-5"
                                        [ngStyle]="rowData[col.field].value && {'background' : rowData[col.field].value}">
                                    </div>
                                </ng-container>

                                <ng-container *ngSwitchCase="fieldType.COLORPICKER">
                                    <ng-container *ngIf="editMode && rowData[col.field]?.isEditMode">
                                        <p-colorPicker [formControlName]="col.field"
                                            [ngClass]="{'empty': !rowData[col.field]?.value}"
                                            (onChange)="onChange($event, rowData, rowIndex, col)"
                                            id="{{col.field+'_'+rowIndex}}"></p-colorPicker>
                                        <cpdss-portal-validation-error [errors]="fieldError(rowIndex, col.field)"
                                            [errorMessages]="col.errorMessages">
                                        </cpdss-portal-validation-error>
                                    </ng-container>
                                    <ng-container *ngIf="!editMode || !rowData[col.field]?.isEditMode">
                                        <div class="colorpicker p-colorpicker-preview p-inputtext"
                                            [style.background-color]="rowData[col.field]?.value">
                                        </div>
                                    </ng-container>
                                </ng-container>

                                <ng-container *ngSwitchCase="fieldType.ARRAY">
                                    <ng-container *ngIf="editMode && rowData[col.field]?.isEditMode">
                                        <a class="btn btn-secondary"
                                            (click)="onCellValueClick($event, rowData, rowIndex, col)"
                                            id="{{col.field+'_'+rowIndex}}">{{rowData[col.arrayLabelField] ?
                                            rowData[col.arrayLabelField]: col.fieldPlaceholder| translate}}</a>
                                        <cpdss-portal-validation-error [errors]="fieldError(rowIndex, col.field)"
                                            [errorMessages]="col.errorMessages">
                                        </cpdss-portal-validation-error>
                                    </ng-container>
                                    <ng-container *ngIf="!editMode || !rowData[col.field]?.isEditMode">
                                        <a (click)="onCellValueClick($event, rowData, rowIndex, col)"
                                            id="{{col.field+'_'+rowIndex}}">{{rowData[col.arrayLabelField] ?
                                            rowData[col.arrayLabelField]: col.fieldPlaceholder| translate}}</a>
                                    </ng-container>
                                </ng-container>
                                <ng-container *ngSwitchCase="fieldType.DATERANGE">
                                    <ng-container *ngIf="editMode && rowData[col.field]?.isEditMode">
                                        <p-calendar appendTo="body" [showButtonBar]="true" [readonlyInput]="true"
                                            [disabled]="disabledField(rowIndex, col.field)"
                                            [hidden]="disabledField(rowIndex, col.field)"
                                            (onSelect)="onDateRangeSelect($event, rowIndex, col.field, rowData)"
                                            (onClose)="onDateRangeSelect($event, rowIndex, col.field, rowData)"
                                            (onClearClick)="onClearDateRange($event, rowIndex, col.field,rowData)"
                                            [dateFormat]="col.dateFormat" selectionMode="range"
                                            [placeholder]="col.fieldPlaceholder| translate" [minDate]="col.minDate"
                                            id="{{col.field+'_'+rowIndex}}" [hideOnDateTimeSelect]="false"
                                            [formControlName]="col.field"
                                            #coldaterange>
                                        </p-calendar>
                                        <cpdss-portal-validation-error [errors]="fieldError(rowIndex, col.field)"
                                            [errorMessages]="col.errorMessages">
                                        </cpdss-portal-validation-error>
                                    </ng-container>
                                    <ng-container *ngIf="!editMode || !rowData[col.field]?.isEditMode">
                                        <span *ngIf="rowData[col.field]?.value?.name">{{ rowData[col.field]?.value?.name
                                            }}</span>
                                        <span *ngIf="!rowData[col.field]?.value?.name">{{ rowData[col.field]?.value
                                            }}</span>
                                    </ng-container>
                                </ng-container>
                                <ng-container *ngSwitchCase="fieldType.DATETIME">
                                    <ng-container *ngIf="editMode && rowData[col.field]?.isEditMode">
                                        <p-calendar appendTo="body" [showTime]="true" [showButtonBar]="true"
                                            [readonlyInput]="true"
                                            (onClose)="onDatePanelClosed($event,rowIndex, col.field,rowData)"
                                            [formControlName]="col.field"
                                            [placeholder]="col.fieldPlaceholder| translate"
                                            inputId="{{col.field+'_'+rowIndex + 'input'}}"
                                            id="{{col.field+'_'+rowIndex}}" [minDate]="col.minDate"
                                            [dateFormat]="col.dateFormat ? col.dateFormat : 'dd-mm-yy'"
                                            [hideOnDateTimeSelect]="false" #coldatetime>
                                            <p-footer>
                                                <div class="text-center">
                                                <button class="btn btn-main"
                                                    (click)="coldatetime.hideOverlay()">{{'DATA_TABLE_OK_BUTTON_LABEL' |
                                                    translate}}</button>
                                                </div>
                                                </p-footer>
                                                
                                        </p-calendar>
                                        <cpdss-portal-validation-error [errors]="fieldError(rowIndex, col.field)"
                                            [errorMessages]="col.errorMessages">
                                        </cpdss-portal-validation-error>
                                    </ng-container>
                                    <ng-container *ngIf="!editMode || !rowData[col.field]?.isEditMode">
                                        <span *ngIf="rowData[col.field]?.value?.name">{{ rowData[col.field]?.value?.name
                                            }}</span>
                                        <span *ngIf="!rowData[col.field]?.value?.name">{{ rowData[col.field]?.value
                                            }}</span>
                                    </ng-container>
                                </ng-container>
                                <span *ngSwitchDefault>{{rowData[col.field]}}</span>
                            </div>
                        </td>
                    </ng-template>
                </tr>
            </ng-template>
            <ng-template pTemplate="footer" let-columns>
                <tr *ngIf="showTotal && value && value.length">
                    <td *ngIf="progress">
                        
                    </td>
                    <td *ngFor="let col of columns; let i = index">
                        {{getTotal(col, i)}}
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage" let-columns>
                <tr>
                    <td [attr.colspan]="totalColSpan">
                        {{'NO_RECORDS_FOUND'| translate}}
                    </td>
                </tr>
            </ng-template>
        </p-table>
        <ng-container *ngIf="paginator">
            <p-paginator  currentPageReportTemplate={{currentPageReportTemplate}} [showJumpToPageDropdown]="true"  #paginator [showCurrentPageReport]="true"   [rows]="rows" [totalRecords]="totalRecords"  (onPageChange)="onPageChange($event)" [rowsPerPageOptions]="rowsPerPage"></p-paginator>
        </ng-container>
        
    </div>
</div>